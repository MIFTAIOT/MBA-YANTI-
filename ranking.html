<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Siswa - MDeV.IoT_SERVER 01</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === IMPORT FONT KEREN === */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500&display=swap'); /* Font Coding */

        body { 
            background: #f0f2f5; 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            color: #333;
            user-select: none;
        }

        .rank-container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            min-height: 100vh; 
            position: relative; 
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* HEADER */
        .header { 
            position: sticky; top: 0; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            padding: 15px 20px; 
            z-index: 100; 
            display: flex; align-items: center; 
            border-bottom: 1px solid #eee;
        }
        .back-btn { 
            border: none; background: none; font-size: 1.2em; cursor: pointer; color: #333; margin-right: 15px; transition: 0.2s;
        }
        .back-btn:active { transform: scale(0.9); }

        /* TABS */
        .tab-container { padding: 15px 20px; background: white; }
        .tab-box { background: #f1f2f6; padding: 5px; border-radius: 15px; display: flex; }
        .tab-btn { 
            flex: 1; padding: 12px; border: none; background: transparent; 
            border-radius: 12px; font-weight: 600; color: #888; cursor: pointer; transition: 0.3s; 
            font-size: 0.9em;
        }
        .tab-btn.active { background: white; color: #2d3436; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* LIST AREA */
        .list-area { padding: 10px 20px; padding-bottom: 80px; min-height: 300px; }

        /* ITEM RANKING */
        .rank-item { 
            display: flex; align-items: center; 
            padding: 15px; margin-bottom: 12px; 
            background: white; border-radius: 16px; 
            border: 1px solid #f0f0f0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: 0.2s; 
        }
        .rank-badge { 
            width: 38px; height: 38px; border-radius: 50%; 
            background: #f8f9fa; display: flex; align-items: center; justify-content: center; 
            font-weight: 800; color: #b2bec3; font-size: 1em; margin-right: 15px; 
        }
        
        /* WARNA JUARA */
        .rank-1 { background: linear-gradient(135deg, #fff, #fffde7); border: 1px solid #fdd835; }
        .rank-1 .rank-badge { background: #fff176; color: #f57f17; font-size: 1.4em; box-shadow: 0 0 10px rgba(253, 216, 53, 0.3); }
        
        .rank-2 { border: 1px solid #e0e0e0; }
        .rank-2 .rank-badge { background: #e0e0e0; color: #757575; font-size: 1.2em; }
        
        .rank-3 { border: 1px solid #ffccbc; }
        .rank-3 .rank-badge { background: #ffccbc; color: #d84315; font-size: 1.2em; }

        /* EFEK SAYA */
        .rank-me { 
            background: #e3f2fd !important; 
            border: 2px solid #2196f3 !important; 
            transform: scale(1.02); 
            z-index: 2;
        }

        /* === LOADER ALA SERVER IOT === */
        #loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 50;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            text-align: center;
        }
        
        .iot-spinner {
            width: 60px; height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite, pulse 1.5s ease-in-out infinite;
            margin-bottom: 20px;
        }

        .server-text {
            font-family: 'JetBrains Mono', monospace; /* Font ala Coding */
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
        }
        
        .blink { animation: blinker 1s linear infinite; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(52, 152, 219, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); } }
        @keyframes blinker { 50% { opacity: 0; } }

    </style>
</head>
<body>

    <div class="rank-container">
        <div class="header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <h1 style="margin:0; font-size:1.1em; font-weight: 700;">Rank Siswa SMAN1KE üèÜ</h1>
        </div>

        <div class="tab-container">
            <div class="tab-box">
                <button id="btn-global" class="tab-btn active" onclick="loadData('global')">
                    <i class="fa-solid fa-earth-asia"></i> Se-Sekolah
                </button>
                <button id="btn-class" class="tab-btn" onclick="loadData('class')">
                    <i class="fa-solid fa-users"></i> Satu Kelas
                </button>
            </div>
        </div>

        <div id="loader-overlay" style="display: none;">
            <div class="iot-spinner"></div>
            <div style="font-weight: bold; color: #2c3e50;">MiDEv.SERVER 01 System</div>
            <div class="server-text">Connecting to server<span class="blink">...</span></div>
            <small style="color:#aaa; font-size:0.7em;">Mengambil data scores...</small>
        </div>

        <div id="list-area" class="list-area" style="display: none;">
            </div>
        
        <div id="status-msg" style="text-align: center; padding: 40px; display: none; color: #888;"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="assets/js/firebase-config.js"></script>

    <script>
        // === LOGIKA LEADERBOARD ALA MIFTA.IOT ===
        let currentUser = null;
        let userData = null;

        // 1. Cek Login
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const doc = await db.collection('users').doc(user.uid).get();
                userData = doc.data();
                
                // Load Default
                loadData('global');
            } else {
                alert("Sesi habis. Login ulang ya!");
                window.location.href = 'index.html';
            }
        });

        function goBack() {
            window.location.href = 'index.html';
        }

        // 3. FUNGSI LOAD DATA DENGAN EFEK DELAY KEREN
        async function loadData(mode) {
            const loader = document.getElementById('loader-overlay');
            const listDiv = document.getElementById('list-area');
            const statusDiv = document.getElementById('status-msg');
            const btnGlobal = document.getElementById('btn-global');
            const btnClass = document.getElementById('btn-class');

            // Atur Tab Active
            if(mode === 'global') {
                btnGlobal.classList.add('active'); btnClass.classList.remove('active');
            } else {
                btnClass.classList.add('active'); btnGlobal.classList.remove('active');
            }

            // A. TAMPILKAN LOADING SCREEN
            listDiv.style.display = 'none';
            statusDiv.style.display = 'none';
            loader.style.display = 'flex'; // Munculkan Overlay
            
            // Ubah teks loading biar dinamis
            const txt = document.querySelector('.server-text');
            txt.innerHTML = `Requesting data from <span style="color:#3498db">server</span><span class="blink">_</span>`;

            // B. TAHAN SELAMA 2 DETIK (EFEK DRAMATIS)
            await new Promise(r => setTimeout(r, 2000));

            try {
                // C. AMBIL DATA DARI FIREBASE (Real)
                const snapshot = await db.collection('users')
                    .where('role', '==', 'student')
                    .get();

                if (snapshot.empty) {
                    loader.style.display = 'none';
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fa-solid fa-ghost" style="font-size:2em; margin-bottom:10px;"></i><br>Belum ada data siswa.';
                    return;
                }

                // D. OLAH DATA (SORTING DI HP)
                let students = [];
                const myClass = userData ? userData.classId : null;

                snapshot.forEach(doc => {
                    const d = doc.data();
                    students.push({
                        uid: doc.id,
                        name: d.displayName || d.name || 'Tanpa Nama',
                        classId: d.classId || 'Umum',
                        score: d.totalScore || 0
                    });
                });

                // Filter jika tab Kelas
                if (mode === 'class') {
                    if (!myClass) {
                        loader.style.display = 'none';
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = 'Kamu belum masuk kelas.';
                        return;
                    }
                    students = students.filter(s => s.classId === myClass);
                }

                // Sorting (Score Terbesar di Atas)
                students.sort((a, b) => b.score - a.score);

                // Ambil Top 50
                const top50 = students.slice(0, 50);

                // E. RENDER HTML
                let html = '';
                let rank = 1;

                top50.forEach(s => {
                    const isMe = (s.uid === currentUser.uid);
                    
                    let itemClass = 'rank-item';
                    let badgeContent = rank;
                    
                    // Styling Juara
                    if (rank === 1) { itemClass += ' rank-1'; badgeContent = 'ü•á'; }
                    else if (rank === 2) { itemClass += ' rank-2'; badgeContent = 'ü•à'; }
                    else if (rank === 3) { itemClass += ' rank-3'; badgeContent = 'ü•â'; }
                    
                    if (isMe) itemClass += ' rank-me';

                    html += `
                    <div class="${itemClass}" style="animation: fadeIn 0.5s ease forwards; opacity: 0; animation-delay: ${rank * 0.05}s;">
                        <div class="rank-badge">${badgeContent}</div>
                        <div style="flex-grow:1;">
                            <div style="font-weight:700; color:#2d3436; font-size:0.95em;">
                                ${s.name} 
                                ${isMe ? '<i class="fa-solid fa-circle-check" style="color:#2196f3; margin-left:5px;"></i>' : ''}
                            </div>
                            <div style="font-size:0.75em; color:#999; margin-top:2px;">
                                <i class="fa-solid fa-users" style="font-size:0.8em;"></i> ${s.classId}
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:800; color:#6c5ce7; font-size:1.1em;">${s.score}</div>
                            <div style="font-size:0.6em; color:#b2bec3; font-weight:600;">XP POINT</div>
                        </div>
                    </div>`;
                    rank++;
                });

                // F. TAMPILKAN HASIL
                loader.style.display = 'none'; // Sembunyikan Loading
                listDiv.style.display = 'block'; // Munculkan List
                listDiv.innerHTML = html;

            } catch (error) {
                console.error(error);
                loader.style.display = 'none';
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `<p style="color:red;">Koneksi Gagal: ${error.message}</p>`;
            }
        }
    </script>
    
    <style>
        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</body>
</html>