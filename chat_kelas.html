<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Classroom Chat - iOS Style</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === TEMA APPLE LIQUID GLASS === */
        :root {
            --primary-blue: #007AFF;
            --primary-grad: linear-gradient(135deg, #007AFF, #00C6FF);
            --glass-white: rgba(255, 255, 255, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --text-dark: #1d1d1f;
            --text-gray: #86868b;
            --bubble-self: #007AFF;
            --bubble-other: rgba(255, 255, 255, 0.8);
        }

        body { 
            margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; 
            background: #f5f5f7; height: 100vh; display: flex; flex-direction: column; 
            overflow: hidden; color: var(--text-dark);
            position: relative;
        }

        /* === ANIMASI LIQUID BACKGROUND === */
        .liquid-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: #fff; overflow: hidden;
        }
        .blob {
            position: absolute; filter: blur(80px); opacity: 0.6;
            animation: moveBlob 10s infinite alternate ease-in-out;
        }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #a2d2ff; animation-duration: 12s; }
        .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #cdb4db; animation-duration: 15s; }
        .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #ffc8dd; animation-duration: 18s; }

        @keyframes moveBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, -30px) scale(1.1); }
        }

        /* HEADER (FROSTED GLASS) */
        .chat-header {
            background: var(--glass-white);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            padding: 15px 20px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 50;
            border-bottom: var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .back-btn { 
            color: var(--primary-blue); font-size: 1.2em; text-decoration: none;
            transition: 0.2s; background: rgba(255,255,255,0.5); width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center; border-radius: 50%;
        }
        .back-btn:active { transform: scale(0.9); background: white; }

        .chat-info h1 { margin: 0; font-size: 1.1em; font-weight: 700; letter-spacing: -0.5px; }
        .chat-info span { font-size: 0.8em; color: var(--text-gray); font-weight: 500; }

        /* DROPDOWN GURU (iOS Style) */
        #teacher-class-select {
            appearance: none; background: rgba(118, 118, 128, 0.12); border: none;
            padding: 8px 15px; border-radius: 12px; color: var(--primary-blue); font-weight: 600;
            font-size: 0.9em; outline: none; cursor: pointer; display: none;
        }

        /* CHAT AREA */
        .chat-container {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 12px;
            scroll-behavior: smooth;
        }
        
        /* SCROLLBAR INVISIBLE (Clean) */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* BUBBLES (iMessage Style) */
        .message-wrapper { 
            display: flex; flex-direction: column; max-width: 75%; 
            animation: springUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .message-wrapper.self { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.other { align-self: flex-start; align-items: flex-start; }

        .bubble {
            padding: 12px 18px; border-radius: 20px;
            font-size: 0.95em; line-height: 1.45; position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); word-wrap: break-word;
        }

        /* SELF (Gradient Blue) */
        .self .bubble {
            background: var(--primary-grad);
            color: white;
            border-bottom-right-radius: 4px; /* Ekor iMessage */
        }
        
        /* OTHER (Glass White) */
        .other .bubble {
            background: var(--bubble-other);
            backdrop-filter: blur(10px);
            border: var(--glass-border);
            color: #333;
            border-bottom-left-radius: 4px; /* Ekor iMessage */
        }

        /* TEACHER (Gold Liquid) */
        .teacher-msg .bubble {
            background: linear-gradient(135deg, #FFD700, #FDB931);
            color: #4a3b00; font-weight: 600; box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        /* SYSTEM MSG (Notification Pill) */
        .system-msg {
            align-self: center; text-align: center;
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            color: var(--text-gray); padding: 8px 20px; border-radius: 30px;
            font-size: 0.8em; margin: 10px 0; width: fit-content;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            font-weight: 600;
        }

        .meta-info { font-size: 0.65em; margin-top: 5px; opacity: 0.6; display: flex; gap: 5px; align-items: center; }
        .sender-name { font-weight: 600; color: #8e8e93; margin-bottom: 4px; font-size: 0.75em; margin-left: 5px; }
        
        /* INPUT AREA (Floating Glass Bar) */
        .input-wrapper {
            padding: 20px; background: transparent;
            display: flex; justify-content: center; z-index: 50;
        }
        .input-bar {
            background: var(--glass-white); backdrop-filter: blur(25px);
            border: var(--glass-border);
            border-radius: 30px; padding: 6px 6px 6px 20px;
            display: flex; align-items: center; width: 100%; max-width: 700px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); transition: transform 0.2s;
        }
        .input-bar:focus-within { transform: translateY(-5px); box-shadow: 0 15px 50px rgba(0,122,255,0.15); }

        .input-field {
            flex: 1; background: transparent; border: none; padding: 10px;
            color: #333; font-family: inherit; font-size: 1em; outline: none;
        }
        
        .btn-send {
            background: var(--primary-blue); color: white; border: none;
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.3s; font-size: 1.1em;
            box-shadow: 0 4px 10px rgba(0,122,255,0.3);
        }
        .btn-send:hover { transform: scale(1.1); }
        .btn-send:active { transform: scale(0.9); }

        /* UTILS */
        @keyframes springUp { 0% { opacity: 0; transform: translateY(20px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .bot-badge { background: #5AC8FA; color: white; padding: 2px 6px; border-radius: 6px; font-size: 0.8em; margin-right: 5px; }
        
        .btn-delete { color: #ff3b30; cursor: pointer; opacity: 0; transition: 0.2s; }
        .message-wrapper:hover .btn-delete { opacity: 1; }
    </style>
</head>
<body>

    <div class="liquid-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="chat-header">
        <div class="header-left">
            <a href="index.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i></a>
            <div class="chat-info">
                <h1 id="header-title">Pesawat pesan</h1>
                <span id="header-subtitle">Syncing...</span>
            </div>
        </div>
        
        <select id="teacher-class-select">
            <option value="">-- Switch Class --</option>
        </select>
    </div>

    <div id="chat-container" class="chat-container">
        <div style="text-align:center; margin-top:50px; color:#aaa;">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Loading messages...
        </div>
    </div>

    <div class="input-wrapper">
        <div class="input-bar">
            <input type="text" id="msg-input" class="input-field" placeholder="ketiken sembarang...sak karepmu" disabled>
            <button id="btn-send" class="btn-send" disabled><i class="fa-solid fa-arrow-up"></i></button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="assets/js/firebase-config.js"></script>

    <script>
        // === LOGIKA CHAT APPLE STYLE ===
        let currentUser = null;
        let currentClassId = null;
        let isTeacher = false;
        let unsubscribeChat = null;

        const BAD_WORDS = ['anjing', 'babi', 'monyet', 'bodoh', 'goblok', 'tolol', 'bangsat', 'fuck', 'shit', 'jancok'];

        // 1. CEK LOGIN
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) window.location.href = 'index.html';
            currentUser = user;
            
            const doc = await db.collection('users').doc(user.uid).get();
            const userData = doc.data();
            isTeacher = userData.role === 'teacher';

            if (isTeacher) {
                document.getElementById('header-subtitle').textContent = "Administrator";
                setupTeacherMode(user.uid);
            } else {
                if (!userData.classId) { alert("Masuk kelas dulu!"); window.location.href='index.html'; return; }
                document.getElementById('header-subtitle').textContent = userData.className || "Online";
                loadChat(userData.classId);
            }
        });

        // 2. SETUP GURU (Dropdown)
        async function setupTeacherMode(uid) {
            const select = document.getElementById('teacher-class-select');
            select.style.display = 'block'; 
            const snap = await db.collection('classes').where('teacherId', '==', uid).get();
            snap.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id; opt.textContent = d.data().name;
                select.appendChild(opt);
            });
            select.onchange = () => { if (select.value) loadChat(select.value); };
        }

        // 3. LOAD CHAT (SMOOTH RENDER)
        function loadChat(classId) {
            currentClassId = classId;
            const container = document.getElementById('chat-container');
            const input = document.getElementById('msg-input');
            const btn = document.getElementById('btn-send');

            input.disabled = false; btn.disabled = false; input.focus();
            if (unsubscribeChat) unsubscribeChat();

            unsubscribeChat = db.collection('chats').where('classId', '==', classId)
                .orderBy('timestamp', 'asc').limitToLast(50)
                .onSnapshot(snapshot => {
                    container.innerHTML = '';
                    if(snapshot.empty) {
                        container.innerHTML = '<div class="system-msg">No messages yet. Start chatting!</div>';
                        return;
                    }

                    let lastSender = '';

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const isMe = data.senderId === currentUser.uid;
                        const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
                        
                        let wrapperClass = isMe ? 'self' : 'other';
                        let senderName = isMe ? '' : data.senderName; // Apple style: no name for self
                        let content = data.text;
                        let extraHtml = '';

                        // SMART FEATURE: TEACHER
                        if (data.role === 'teacher') {
                            wrapperClass += ' teacher-msg';
                            senderName = `ðŸ‘‘ ${data.senderName}`;
                        }

                        // SMART FEATURE: ANNOUNCEMENT
                        if (data.type === 'announcement') {
                            const div = document.createElement('div');
                            div.className = 'system-msg';
                            div.style.color = '#ff3b30';
                            div.innerHTML = `<i class="fa-solid fa-bullhorn"></i> <strong>ANNOUNCEMENT:</strong><br>${data.text}`;
                            container.appendChild(div);
                            return;
                        }

                        // SMART FEATURE: BOT
                        if (data.type === 'bot') {
                            const div = document.createElement('div');
                            div.className = 'system-msg';
                            div.style.color = '#007AFF';
                            div.innerHTML = `<span class="bot-badge">BOT</span> ${data.text}`;
                            container.appendChild(div);
                            return;
                        }

                        // DELETE BUTTON
                        if (isTeacher) {
                            extraHtml = `<i class="fa-solid fa-xmark btn-delete" onclick="deleteMessage('${doc.id}')"></i>`;
                        }

                        // RENDER
                        const div = document.createElement('div');
                        div.className = `message-wrapper ${wrapperClass}`;
                        div.innerHTML = `
                            ${(!isMe && lastSender !== data.senderName) ? `<span class="sender-name">${senderName}</span>` : ''}
                            <div class="bubble">
                                ${content}
                            </div>
                            <div class="meta-info">
                                ${time} ${extraHtml}
                            </div>
                        `;
                        container.appendChild(div);
                        lastSender = data.senderName;
                    });
                    
                    // Smooth Scroll
                    setTimeout(() => container.scrollTop = container.scrollHeight, 100);
                });
        }

        // 4. KIRIM PESAN
        async function sendMessage() {
            const input = document.getElementById('msg-input');
            let text = input.value.trim();
            if (!text || !currentClassId) return;

            input.value = '';

            // COMMANDS
            if (text.startsWith('/')) return handleSmartCommand(text);

            // SENSOR (Emoji Badut)
            BAD_WORDS.forEach(bad => {
                const regex = new RegExp(bad, "gi");
                text = text.replace(regex, "ðŸ¤¡"); 
            });

            try {
                await db.collection('chats').add({
                    classId: currentClassId,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName.split('_')[1] || currentUser.displayName, 
                    role: isTeacher ? 'teacher' : 'student',
                    type: 'text',
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) { console.error(e); }
        }

        // 5. SMART COMMANDS
        async function handleSmartCommand(cmd) {
            if (cmd === '/roll') {
                if (!isTeacher) return alert("Teacher only!");
                const snap = await db.collection('users').where('classId', '==', currentClassId).where('role', '==', 'student').get();
                if (snap.empty) return;
                const students = snap.docs.map(d => d.data().name);
                const chosen = students[Math.floor(Math.random() * students.length)];
                
                await db.collection('chats').add({
                    classId: currentClassId, role: 'bot', type: 'bot',
                    text: `ðŸŽ² Random Picker selected: **${chosen}**!`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else if (cmd.startsWith('/announce ')) {
                if (!isTeacher) return alert("Teacher only!");
                await db.collection('chats').add({
                    classId: currentClassId, role: 'teacher', type: 'announcement',
                    text: cmd.replace('/announce ', ''),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                alert("Unknown command.");
            }
        }

        // Listeners
        document.getElementById('btn-send').onclick = sendMessage;
        document.getElementById('msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        window.deleteMessage = async function(docId) {
            if(confirm("Delete message?")) await db.collection('chats').doc(docId).delete();
        };
    </script>
</body>
</html>